@{
    string roll = ViewBag.Roll as string ?? "";
    int year = (int)ViewBag.Year;
    int month = (int)ViewBag.Month;
    var grid = ViewBag.Grid as IDictionary<DateTime, string> ?? new Dictionary<DateTime, string>();

    int present = (int)ViewBag.Present;
    int absent = (int)ViewBag.Absent;
    int late = (int)ViewBag.Late;
    int notMarked = (int)ViewBag.NotMarked;
    var today = DateTime.Today;

    var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month);
    DateTime firstDayOfMonth = new DateTime(year, month, 1);
    int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
    int daysInMonth = DateTime.DaysInMonth(year, month);
    int totalCells = ((firstDayOfWeek + daysInMonth) % 7 == 0)
        ? (firstDayOfWeek + daysInMonth)
        : (firstDayOfWeek + daysInMonth + 7 - (firstDayOfWeek + daysInMonth) % 7);
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-9">
            <!-- Made wider -->
            <div class="card shadow-sm mb-4">
                <div class="card-body pb-2">
                    <h2 class="text-center mb-3">My Attendance – @monthName @year</h2>

                    <!-- Month Navigation -->
                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <a asp-action="AttendanceHistory" asp-route-roll="@roll"
                           asp-route-year="@(month == 1 ? year - 1 : year)"
                           asp-route-month="@(month == 1 ? 12 : month - 1)"
                           class="btn btn-outline-secondary btn-sm">&lt; Prev</a>
                        <strong style="font-size: 1.4em;">@monthName @year</strong>
                        <a asp-action="AttendanceHistory" asp-route-roll="@roll"
                           asp-route-year="@(month == 12 ? year + 1 : year)"
                           asp-route-month="@(month == 12 ? 1 : month + 1)"
                           class="btn btn-outline-secondary btn-sm">Next &gt;</a>
                    </div>

                    <!-- Summary -->
                    <div class="d-flex justify-content-center gap-3 mb-3">
                        <span class="badge rounded-pill badge-present fs-6">Present: @present</span>
                        <span class="badge rounded-pill badge-absent fs-6">Absent: @absent</span>
                        <span class="badge rounded-pill badge-late fs-6">Late: @late</span>
                        <span class="badge rounded-pill badge-not-marked fs-6">Not Marked: @notMarked</span>
                    </div>


                    <!-- Calendar -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered text-center attendance-month-calendar">
                            <thead class="table-light">
                                <tr>
                                    <th>Su</th>
                                    <th>Mo</th>
                                    <th>Tu</th>
                                    <th>We</th>
                                    <th>Th</th>
                                    <th>Fr</th>
                                    <th>Sa</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int cell = 0;
                                    for (int row = 0; row < totalCells / 7; row++)
                                    {
                                        <tr>
                                            @for (int col = 0; col < 7; col++, cell++)
                                            {
                                                int dayVal = cell - firstDayOfWeek + 1;
                                                if (cell < firstDayOfWeek || dayVal > daysInMonth)
                                                {
                                                    <td></td>
                                                }
                                                else
                                                {
                                                    var d = new DateTime(year, month, dayVal);
                                                    var status = grid.ContainsKey(d) ? grid[d] : "Not Marked";
                                                    string statusClass = status switch
                                                    {
                                                        "Present" => "present",
                                                        "Absent" => "absent",
                                                        "Late" => "late",
                                                        "Not Marked" => "not-marked",
                                                        _ => "default-day"
                                                    };

                                                    bool isToday = (d == today);
                                                    <td class="attendance-cell @statusClass @(isToday ? "today-border" : "")"
                                                        title="@($"{d:yyyy-MM-dd}: {status}")">
                                                        @dayVal
                                                    </td>
                                                }
                                            }
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>

                        <!-- Custom Styles -->
                        <style>
                            .attendance-month-calendar th,
                            .attendance-month-calendar td {
                                text-align: center;
                                vertical-align: middle;
                                font-size: 18px;
                                height: 60px;
                                width: 60px;
                                padding: 0 !important;
                            }

                            .attendance-cell {
                                border-radius: 6px;
                                font-weight: bold;
                                cursor: pointer;
                                color: white;
                                transition: transform 0.2s;
                            }

                                .attendance-cell:hover {
                                    transform: scale(1.1);
                                }

                            .present {
                                background-color: #6BEE37 !important; /* Light green */
                                color: #000 !important;
                            }

                            .absent {
                                background-color: #E55151 !important; /* Light red */
                                color: #000 !important;
                            }

                            .late {
                                background-color: #f4c542 !important; /* Orange */
                                color: #000 !important;
                            }

                            .not-marked {
                                background-color: #b0b0b0 !important; /* Ash grey */
                                color: #000 !important;
                            }

                            .badge-present {
                                background-color: #6BEE37 !important; /* match your calendar present color */
                                color: #000 !important;
                            }

                            .badge-absent {
                                background-color: #E55151 !important; /* match your calendar absent color */
                                color: #000 !important;
                            }

                            .badge-late {
                                background-color: #f4c542 !important; /* match your calendar late color */
                                color: #000 !important;
                            }

                            .badge-not-marked {
                                background-color: #b0b0b0 !important; /* match your calendar not-marked color */
                                color: #000 !important;
                            }



                            /* Highlight today's date */
                            .today-border {
                                border: 3px solid #007bff;
                            }
                        </style>
                    </div>
                </div>

                <div class="card-footer bg-white border-0 pt-0">
                    <div class="d-flex justify-content-start">
                        <a asp-action="Index" asp-route-roll="@roll" class="btn btn-outline-secondary mb-0">
                            <i class="bi bi-chevron-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
